<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Company Policy Assistant</title>
		<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
	</head>
	<body>
		<div class="app">
			<div class="chat-card">
				<div class="chat-header">
					<div class="title-row">
						<svg class="icon-briefcase" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
							<path d="M9 7V6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1" stroke-width="1.6"/>
							<rect x="3" y="7" width="18" height="13" rx="2.2" stroke-width="1.6"/>
							<path d="M3 12h18" stroke-width="1.6"/>
						</svg>
						<h1>Company Policy Assistant</h1>
					</div>
				</div>

			<div id="messages" class="messages" aria-live="polite" aria-relevant="additions">
				<div id="welcome-popup" class="welcome-popup">
					<h2>Welcome to Company Policy Assistant</h2>
					<p>I'm here to help you with any type of policy questions. Just type your question below to get started!</p>
				</div>
			</div>				<form id="chat-form" class="input-row" autocomplete="off">
					<label for="user-input" class="sr-only">Your message</label>
					<textarea id="user-input" rows="1" placeholder="Ask me about leave, benefits, or procedures..." ></textarea>
					<button class="send-btn" id="send-btn" type="submit" aria-label="Send">
						<svg class="icon-send" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
							<path d="M5 12h8" stroke-width="1.8" stroke-linecap="round"/>
							<path d="M5 12l14-7-4.5 7L19 19 5 12z" stroke-width="1.4" stroke-linejoin="round"/>
						</svg>
					</button>
				</form>
			</div>
		</div>

		<script>
			const $messages = document.getElementById('messages');
			const $form = document.getElementById('chat-form');
			const $input = document.getElementById('user-input');
			const $send = document.getElementById('send-btn');
			const $welcomePopup = document.getElementById('welcome-popup');
			let typingNode = null;

			function nowTime() {
				const d = new Date();
				let h = d.getHours();
				const m = String(d.getMinutes()).padStart(2, '0');
				const ampm = h >= 12 ? 'PM' : 'AM';
				h = h % 12; h = h ? h : 12;
				return `${h}:${m} ${ampm}`;
			}

			// Hide welcome popup only when user starts typing
			function hideWelcomePopup() {
				if ($welcomePopup) {
					$welcomePopup.classList.add('hidden');
				}
			}

			function appendMessage(role, text, sources) {
				const wrapper = document.createElement('div');
				wrapper.className = `message ${role}`;

				const bubble = document.createElement('div');
				bubble.className = 'bubble appear';
				bubble.textContent = text;

				if (role === 'assistant' && Array.isArray(sources) && sources.length) {
					const src = document.createElement('div');
					src.className = 'sources';
					src.textContent = 'Sources: ' + sources.join(', ');
					bubble.appendChild(src);
				}

				const ts = document.createElement('div');
				ts.className = 'timestamp';
				ts.textContent = nowTime();
				bubble.appendChild(ts);

				wrapper.appendChild(bubble);
				$messages.appendChild(wrapper);
				scrollToBottom();
			}

			function appendTyping() {
				removeTyping();
				typingNode = document.createElement('div');
				typingNode.className = 'message assistant';
				const bubble = document.createElement('div');
				bubble.className = 'bubble typing';
				bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
				typingNode.appendChild(bubble);
				$messages.appendChild(typingNode);
				scrollToBottom();
			}

			function removeTyping() {
				if (typingNode && typingNode.parentNode) {
					typingNode.parentNode.removeChild(typingNode);
					typingNode = null;
				}
			}

			function scrollToBottom() {
				$messages.scrollTo({ top: $messages.scrollHeight, behavior: 'smooth' });
			}

			async function sendMessage(text) {
				// Hide welcome popup when message is sent
				hideWelcomePopup();
				
				$send.disabled = true;
				try {
					appendMessage('user', text);
					appendTyping();
					const res = await fetch('/chat', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ message: text })
					});
					const data = await res.json();
					if (!res.ok) {
						removeTyping();
						appendMessage('assistant', data.error || 'Something went wrong.');
						return;
					}
					removeTyping();
					appendMessage('assistant', data.answer || '', data.sources || []);
				} catch (err) {
					removeTyping();
					appendMessage('assistant', 'Network error. Please try again.');
				} finally {
					$send.disabled = false;
				}
			}

			$form.addEventListener('submit', (e) => {
				e.preventDefault();
				const text = ($input.value || '').trim();
				if (!text) return;
				$input.value = '';
				$input.style.height = 'auto';
				sendMessage(text);
			});

			$input.addEventListener('input', () => {
				$input.style.height = 'auto';
				$input.style.height = Math.min($input.scrollHeight, 200) + 'px';
			});
			$input.addEventListener('keydown', (e) => {
				if (e.key === 'Enter' && !e.shiftKey) {
					e.preventDefault();
					$form.dispatchEvent(new Event('submit'));
				}
			});
		</script>
	</body>
	</html>

